<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏–∑ –∫–æ–∂–∏ - Detect Skin</title>
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Press Start 2P', cursive;
            background: #000;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,255,255,0.03) 2px, rgba(0,255,255,0.03) 4px),
                repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(255,0,255,0.03) 2px, rgba(255,0,255,0.03) 4px);
            min-height: 100vh;
            padding: 20px;
            color: #00ffff;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: #1a1a2e;
            border: 4px solid #00ffff;
            border-radius: 0;
            box-shadow: 
                0 0 20px #00ffff,
                inset 0 0 20px rgba(0,255,255,0.1);
            overflow: hidden;
            position: relative;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                transparent,
                transparent 2px,
                rgba(0,255,255,0.1) 2px,
                rgba(0,255,255,0.1) 4px
            );
            pointer-events: none;
            opacity: 0.3;
        }

        .header {
            background: linear-gradient(180deg, #ff00ff 0%, #ff0080 50%, #8000ff 100%);
            color: #fff;
            padding: 30px;
            text-align: center;
            border-bottom: 4px solid #00ffff;
            position: relative;
            text-shadow: 
                3px 3px 0 #000,
                0 0 10px #00ffff,
                0 0 20px #00ffff;
            box-shadow: 0 4px 0 #000;
        }

        .header h1 {
            font-size: 1.8em;
            margin-bottom: 15px;
            letter-spacing: 2px;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from {
                text-shadow: 
                    3px 3px 0 #000,
                    0 0 10px #00ffff,
                    0 0 20px #00ffff;
            }
            to {
                text-shadow: 
                    3px 3px 0 #000,
                    0 0 20px #00ffff,
                    0 0 30px #00ffff,
                    0 0 40px #00ffff;
            }
        }

        .header p {
            font-size: 0.7em;
            color: #00ffff;
            text-shadow: 2px 2px 0 #000;
        }

        .content {
            padding: 30px;
            background: #0f0f1e;
        }

        .upload-section {
            background: #1a1a2e;
            border: 4px dashed #00ffff;
            border-radius: 0;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.2s;
            box-shadow: 
                0 0 15px rgba(0,255,255,0.3),
                inset 0 0 15px rgba(0,255,255,0.1);
        }

        .upload-section:hover {
            border-color: #ff00ff;
            box-shadow: 
                0 0 25px rgba(255,0,255,0.5),
                inset 0 0 25px rgba(255,0,255,0.2);
            background: #1f1f3e;
        }

        .upload-section.dragover {
            border-color: #ff00ff;
            background: #2a1a3e;
            box-shadow: 
                0 0 30px rgba(255,0,255,0.7),
                inset 0 0 30px rgba(255,0,255,0.3);
        }

        #fileInput {
            display: none;
        }

        .upload-btn, .btn-reset, .btn-analyze {
            background: #00ffff;
            color: #000;
            border: 3px solid #000;
            padding: 15px 30px;
            font-size: 0.7em;
            border-radius: 0;
            cursor: pointer;
            font-family: 'Press Start 2P', cursive;
            text-transform: uppercase;
            box-shadow: 
                4px 4px 0 #000,
                0 0 10px rgba(0,255,255,0.5);
            transition: all 0.1s;
            margin: 10px;
            position: relative;
            letter-spacing: 1px;
        }

        .upload-btn:hover, .btn-reset:hover, .btn-analyze:hover {
            transform: translate(2px, 2px);
            box-shadow: 
                2px 2px 0 #000,
                0 0 20px rgba(0,255,255,0.8);
        }

        .upload-btn:active, .btn-reset:active, .btn-analyze:active {
            transform: translate(4px, 4px);
            box-shadow: 0 0 0 #000;
        }

        .btn-reset {
            background: #ff0080;
            color: #fff;
            box-shadow: 
                4px 4px 0 #000,
                0 0 10px rgba(255,0,128,0.5);
        }

        .btn-reset:hover {
            box-shadow: 
                2px 2px 0 #000,
                0 0 20px rgba(255,0,128,0.8);
        }

        .btn-analyze {
            background: #00ff00;
            color: #000;
            width: 100%;
            max-width: 400px;
            box-shadow: 
                4px 4px 0 #000,
                0 0 10px rgba(0,255,0,0.5);
        }

        .btn-analyze:hover {
            box-shadow: 
                2px 2px 0 #000,
                0 0 20px rgba(0,255,0,0.8);
        }

        .btn-analyze:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
            box-shadow: 2px 2px 0 #000;
        }

        .preview-section {
            margin: 30px 0;
            text-align: center;
        }

        .preview-image {
            max-width: 100%;
            max-height: 400px;
            border: 4px solid #00ffff;
            border-radius: 0;
            box-shadow: 
                0 0 20px rgba(0,255,255,0.6),
                inset 0 0 20px rgba(0,255,255,0.2);
            margin: 20px 0;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        .buttons-group {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }

        .results-section {
            margin-top: 30px;
            display: none;
            border: 4px solid #ff00ff;
            padding: 20px;
            background: #1a1a2e;
            box-shadow: 
                0 0 20px rgba(255,0,255,0.5),
                inset 0 0 20px rgba(255,0,255,0.1);
        }

        .results-section.show {
            display: block;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .result-card {
            background: #0f0f1e;
            border: 3px solid #00ffff;
            border-radius: 0;
            padding: 15px;
            text-align: center;
            transition: all 0.2s;
            box-shadow: 
                4px 4px 0 #000,
                0 0 10px rgba(0,255,255,0.3);
            position: relative;
        }

        .result-card:hover {
            transform: translate(2px, 2px);
            box-shadow: 
                2px 2px 0 #000,
                0 0 20px rgba(0,255,255,0.6);
            border-color: #ff00ff;
        }

        .result-label {
            font-size: 0.5em;
            color: #00ffff;
            margin-bottom: 10px;
            text-transform: uppercase;
            text-shadow: 2px 2px 0 #000;
            line-height: 1.5;
        }

        .result-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #ff00ff;
            margin-bottom: 8px;
            text-shadow: 
                2px 2px 0 #000,
                0 0 10px rgba(255,0,255,0.8);
        }

        .images-gallery {
            margin-top: 30px;
            margin-bottom: 30px;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .gallery-item {
            background: #0f0f1e;
            border: 3px solid #00ffff;
            border-radius: 0;
            padding: 10px;
            text-align: center;
            transition: all 0.2s;
            box-shadow: 
                4px 4px 0 #000,
                0 0 10px rgba(0,255,255,0.3);
            position: relative;
            overflow: hidden;
        }

        .gallery-item:hover {
            transform: translate(2px, 2px);
            box-shadow: 
                2px 2px 0 #000,
                0 0 20px rgba(0,255,255,0.6);
            border-color: #ff00ff;
        }

        .gallery-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border: 2px solid #00ffff;
            margin-bottom: 10px;
            image-rendering: auto;
        }

        .gallery-title {
            font-size: 0.5em;
            color: #00ffff;
            margin-bottom: 5px;
            text-transform: uppercase;
            text-shadow: 2px 2px 0 #000;
            line-height: 1.3;
            word-wrap: break-word;
        }

        .gallery-meta {
            font-size: 0.4em;
            color: #ff00ff;
            text-shadow: 1px 1px 0 #000;
            opacity: 0.8;
        }

        .result-grade {
            font-size: 0.5em;
            font-weight: bold;
            text-shadow: 1px 1px 0 #000;
        }

        .result-grade.high {
            color: #ff0080;
            text-shadow: 
                1px 1px 0 #000,
                0 0 10px rgba(255,0,128,0.8);
        }

        .result-grade.medium {
            color: #ffaa00;
            text-shadow: 
                1px 1px 0 #000,
                0 0 10px rgba(255,170,0,0.8);
        }

        .result-grade.low {
            color: #00ff00;
            text-shadow: 
                1px 1px 0 #000,
                0 0 10px rgba(0,255,0,0.8);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            margin: 0 auto 20px;
            position: relative;
        }

        .spinner::before,
        .spinner::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border: 4px solid transparent;
            border-top-color: #00ffff;
            border-right-color: #ff00ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .spinner::after {
            border-top-color: #ff00ff;
            border-right-color: #00ff00;
            animation: spin 1.5s linear infinite reverse;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #1a0000;
            border: 3px solid #ff0080;
            border-radius: 0;
            padding: 15px;
            margin: 20px 0;
            color: #ff0080;
            display: none;
            box-shadow: 
                4px 4px 0 #000,
                0 0 15px rgba(255,0,128,0.5);
            text-shadow: 2px 2px 0 #000;
            font-size: 0.6em;
            line-height: 1.8;
        }

        .error-message.show {
            display: block;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: #1a1a2e;
            border: 4px solid #ff00ff;
            border-radius: 0;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            box-shadow: 
                0 0 30px rgba(255,0,255,0.7),
                inset 0 0 30px rgba(255,0,255,0.2);
            text-align: center;
        }

        .heuristic-markers {
            position: relative;
            display: inline-block;
        }

        .heuristic-marker {
            position: absolute;
            cursor: pointer;
            z-index: 10;
        }

        .heuristic-marker.point-marker {
            width: 30px;
            height: 30px;
            transform: translate(-50%, -50%);
        }

        .heuristic-marker.dot-marker {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #ff0080;
            border: 2px solid #00ffff;
            box-shadow: 0 0 8px rgba(255,0,128,0.8);
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 10;
        }

        .heuristic-marker.dot-marker:hover {
            width: 12px;
            height: 12px;
            box-shadow: 0 0 15px rgba(255,0,128,1);
        }

        .heuristic-marker.area-marker {
            border: 3px solid #00ffff;
            background: rgba(255, 0, 128, 0.3);
            box-shadow: 0 0 10px rgba(255,0,128,0.6), inset 0 0 10px rgba(255,0,128,0.3);
            transition: all 0.2s;
        }

        .heuristic-marker.area-marker.ellipse {
            border-radius: 50%;
        }

        .heuristic-marker.area-marker.polygon {
            border-radius: 20% 30% 25% 35%;
            clip-path: polygon(20% 0%, 80% 0%, 100% 20%, 100% 80%, 80% 100%, 20% 100%, 0% 80%, 0% 20%);
        }

        .heuristic-marker.area-marker:hover {
            background: rgba(255, 0, 255, 0.5);
            border-color: #ff00ff;
            box-shadow: 0 0 20px rgba(255,0,128,1), inset 0 0 15px rgba(255,0,128,0.5);
        }

        .heuristic-marker-polygon {
            width: 100%;
            height: 100%;
            fill: #ff0080;
            stroke: #00ffff;
            stroke-width: 3;
            filter: drop-shadow(0 0 5px rgba(255,0,128,0.8));
            transition: all 0.2s;
        }

        .heuristic-marker:hover .heuristic-marker-polygon {
            fill: #ff00ff;
            stroke: #00ffff;
            stroke-width: 4;
            filter: drop-shadow(0 0 15px rgba(255,0,128,1));
            transform: scale(1.2);
        }

        .heuristic-tooltip {
            position: absolute;
            background: #1a1a2e;
            border: 2px solid #00ffff;
            padding: 10px;
            font-size: 0.5em;
            color: #00ffff;
            white-space: nowrap;
            z-index: 20;
            pointer-events: none;
            box-shadow: 4px 4px 0 #000;
        }

        .info-text {
            color: #00ffff;
            font-size: 0.5em;
            margin-top: 10px;
            text-shadow: 1px 1px 0 #000;
            line-height: 1.8;
        }

        h2 {
            color: #00ffff;
            text-shadow: 
                2px 2px 0 #000,
                0 0 10px rgba(0,255,255,0.8);
            font-size: 0.9em;
            margin-bottom: 15px;
        }

        /* Settings Panel */
        .settings-toggle, .language-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #00ffff;
            color: #000;
            border: 3px solid #000;
            padding: 10px 15px;
            font-size: 0.6em;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 4px 4px 0 #000;
            font-family: 'Press Start 2P', cursive;
        }

        .settings-toggle:hover, .language-toggle:hover {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 #000;
        }

        .language-toggle {
            top: 80px;
            background: #ff00ff;
            color: #fff;
        }

        .language-toggle:hover {
            box-shadow: 2px 2px 0 #000, 0 0 20px rgba(255,0,255,0.8);
        }

        .settings-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 380px;
            height: 100vh;
            background: #1a1a2e;
            border-left: 4px solid #00ffff;
            padding: 20px;
            overflow-y: auto;
            z-index: 999;
            transition: right 0.3s ease;
            box-shadow: -4px 0 20px rgba(0,0,0,0.5);
        }

        .settings-panel.open {
            right: 0;
        }

        .settings-panel h3 {
            color: #00ffff;
            font-size: 0.8em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 0 #000;
            border-bottom: 2px solid #00ffff;
            padding-bottom: 10px;
        }

        .setting-group {
            margin-bottom: 20px;
        }

        .setting-label {
            color: #00ffff;
            font-size: 0.5em;
            margin-bottom: 8px;
            display: block;
            text-shadow: 1px 1px 0 #000;
        }

        .setting-select, .setting-input {
            width: 100%;
            background: #0f0f1e;
            border: 2px solid #00ffff;
            color: #00ffff;
            padding: 10px;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.5em;
            margin-bottom: 10px;
        }

        .setting-select:focus, .setting-input:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(0,255,255,0.5);
        }

        .setting-range {
            width: 100%;
            margin: 10px 0;
        }

        .setting-value {
            color: #ff00ff;
            font-size: 0.5em;
            text-align: center;
            margin-top: 5px;
        }

        .report-section {
            margin-top: 20px;
            padding: 15px;
            background: #0f0f1e;
            border: 2px solid #ff00ff;
            color: #00ffff;
            font-size: 0.5em;
            line-height: 1.8;
            max-height: 300px;
            overflow-y: auto;
            text-shadow: 1px 1px 0 #000;
            display: none;
        }

        .report-section.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="headerTitle">SKIN ANALYZER</h1>
            <p id="headerSubtitle">DETECT DISEASE TYPE</p>
        </div>

        <button class="settings-toggle" onclick="toggleSettings()" id="settingsBtn">‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò</button>
        <button class="language-toggle" onclick="toggleLanguage()" id="languageBtn">üåê EN</button>

        <div class="settings-panel" id="settingsPanel">
            <h3 id="settingsTitle">–ù–ê–°–¢–†–û–ô–ö–ò –ú–û–î–ï–õ–ò</h3>
            
            <div class="setting-group">
                <label class="setting-label" id="detectionProviderLabel">–ü–†–û–í–ê–ô–î–ï–† –î–ï–¢–ï–ö–¶–ò–ò</label>
                <select class="setting-select" id="detectionProvider">
                    <option value="openrouter">OpenRouter</option>
                </select>
            </div>

            <div class="setting-group">
                <label class="setting-label" id="visionModelLabel">–ú–û–î–ï–õ–¨ –í–ò–ó–ò–ò</label>
                <select class="setting-select" id="visionModel">
                    <!-- –û–ø—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∏–∑ /api/models/available -->
                </select>
            </div>

            <div class="setting-group">
                <label class="setting-label" id="llmProviderLabel">–ü–†–û–í–ê–ô–î–ï–† LLM</label>
                <select class="setting-select" id="llmProvider">
                    <option value="openrouter">OpenRouter</option>
                </select>
            </div>

            <div class="setting-group">
                <label class="setting-label" id="textModelLabel">–¢–ï–ö–°–¢–û–í–ê–Ø –ú–û–î–ï–õ–¨</label>
                <select class="setting-select" id="textModel">
                    <!-- –û–ø—Ü–∏–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∏–∑ /api/models/available -->
                </select>
            </div>

            <div class="setting-group">
                <label class="setting-label" id="temperatureLabel">–¢–ï–ú–ü–ï–†–ê–¢–£–†–ê: <span class="setting-value" id="tempValue">0</span></label>
                <input type="range" class="setting-range" id="temperature" min="0" max="1" step="0.1" value="0" oninput="updateTempValue(this.value)">
            </div>

            <div class="setting-group">
                <label class="setting-label" id="maxTokensLabel">MAX TOKENS: <span class="setting-value" id="tokensValue">300</span></label>
                <input type="range" class="setting-range" id="maxTokens" min="100" max="2000" step="100" value="300" oninput="updateTokensValue(this.value)">
            </div>

            <button class="upload-btn" onclick="saveSettings()" style="width: 100%; margin-top: 20px;" id="saveSettingsBtn">
                –°–û–•–†–ê–ù–ò–¢–¨
            </button>
        </div>

        <div class="content">
            <div class="upload-section" id="uploadSection">
                <h2 id="uploadTitle">–ó–ê–ì–†–£–ó–ò–¢–¨ –§–û–¢–û</h2>
                <p class="info-text" id="uploadInfo">–ü–ï–†–ï–¢–ê–©–ò–¢–ï –ò–õ–ò –ù–ê–ñ–ú–ò–¢–ï –ö–ù–û–ü–ö–£</p>
                <input type="file" id="fileInput" accept="image/*,.heic,.heif,image/heic,image/heif">
                <div class="buttons-group">
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()" id="selectFileBtn">
                        –í–´–ë–†–ê–¢–¨ –§–ê–ô–õ
                    </button>
                </div>
            </div>

            <div class="preview-section" id="previewSection" style="display: none;">
                <img id="previewImage" class="preview-image" alt="Preview">
                <div class="buttons-group">
                    <button class="btn-reset" onclick="resetImage()" id="resetBtn">–°–ë–†–û–°–ò–¢–¨</button>
                    <button class="btn-analyze" id="analyzeBtn" onclick="analyzeSkin()">
                        –ê–ù–ê–õ–ò–ó–ò–†–û–í–ê–¢–¨
                    </button>
                </div>
                
                <!-- SAM3 –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                <div id="sam3Controls" style="display:none; margin-top: 15px; padding: 12px; border: 1px solid #00ffff; background: rgba(0,255,255,0.05);">
                    <h4 style="color:#ff00ff; margin-bottom:8px;">SAM3 –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h4>
                    <label style="color:#00ffff; font-size:0.7em;">–¢–∞–π–º–∞—É—Ç (—Å–µ–∫) <span id="sam3TimeoutValue">5</span> ‚Äî —á–µ–º –±–æ–ª—å—à–µ —Ç–∞–π–º–∞—É—Ç, —Ç–µ–º —Ç–æ—á–Ω–µ–µ, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ</label>
                    <input type="range" id="sam3Timeout" min="3" max="20" step="1" value="5" style="width:100%;" oninput="updateSam3Timeout(this.value)">
                    
                    <div style="margin-top:10px;">
                        <label style="color:#00ffff; font-size:0.7em;">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏—è (–≤–∫–ª—é—á–∞—Ç—å/–≤—ã–∫–ª—é—á–∞—Ç—å)</label>
                        <div id="sam3DiseasesList" style="display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:6px; margin-top:6px; color:#00ffff; font-size:0.65em;">
                            <!-- —á–µ–∫–±–æ–∫—Å—ã –±—É–¥—É—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã —Å–∫—Ä–∏–ø—Ç–æ–º -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p style="color: #00ffff; text-shadow: 2px 2px 0 #000; font-size: 0.6em;" id="loadingText">–ê–ù–ê–õ–ò–ó–ò–†–£–Æ...</p>
            </div>

            <div class="error-message" id="errorMessage"></div>

            <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞ -->
            <div class="modal-overlay" id="modeModal" style="display: none;">
                <div class="modal-content">
                    <h3 style="color: #ff00ff; margin-bottom: 15px; text-align: center;">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º –∞–Ω–∞–ª–∏–∑–∞</h3>
                    <p style="color: #00ffff; font-size: 0.6em; line-height: 1.6; margin-bottom: 15px; text-align: center;">
                        <strong>Pixelbin</strong> ‚Äî —Ç–µ–∫—É—â–µ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ (Pixelbin ‚Üí —ç–≤—Ä–∏—Å—Ç–∏–∫–∏)<br>
                        <strong>SAM3</strong> ‚Äî —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è —á–µ—Ä–µ–∑ fal sam-3 —Å –º–∞—Å–∫–∞–º–∏
                    </p>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button class="upload-btn" style="flex:1;" onclick="selectMode('pixelbin')">Pixelbin</button>
                        <button class="upload-btn" style="flex:1;" onclick="selectMode('sam3')">SAM3</button>
                    </div>
                    <button class="upload-btn" onclick="closeModeModal()" style="width: 100%;">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </div>

            <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± —ç–≤—Ä–∏—Å—Ç–∏–∫–µ -->
            <div class="modal-overlay" id="heuristicModal" style="display: none;">
                <div class="modal-content">
                    <h3 style="color: #ff00ff; margin-bottom: 15px; text-align: center;">‚ö†Ô∏è –≠–í–†–ò–°–¢–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó</h3>
                    <p style="color: #00ffff; font-size: 0.6em; line-height: 1.6; margin-bottom: 15px; text-align: center;" id="heuristicModalMessage">
                        Pixelbin API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.<br>
                        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —ç–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑.<br>
                        –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–æ–≥—É—Ç –±—ã—Ç—å –º–µ–Ω–µ–µ —Ç–æ—á–Ω—ã–º–∏.
                    </p>
                    <div id="heuristicMethodsList" style="color: #00ffff; font-size: 0.5em; line-height: 1.8; margin-bottom: 20px; text-align: left; padding: 10px; background: rgba(0,255,255,0.1); border: 1px solid #00ffff;">
                        <strong style="color: #ff00ff;">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã:</strong><br>
                        <span id="methodsText">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                    <button class="upload-btn" onclick="closeHeuristicModal()" style="width: 100%;">
                        –ü–û–ù–Ø–¢–ù–û
                    </button>
                </div>
            </div>

            <div class="results-section" id="resultsSection">
                <div id="statusLogContainer" style="display:none; margin-bottom:15px; padding:10px; border:1px solid #00ffff; background: rgba(0,255,255,0.05);">
                    <h4 style="color:#ff00ff; margin-bottom:8px;">–°—Ç–∞—Ç—É—Å</h4>
                    <pre id="statusLog" style="color:#00ffff; font-size:0.65em; white-space:pre-wrap; max-height:220px; overflow:auto; background:rgba(0,0,0,0.4); padding:8px; border:1px solid #00ffff;"></pre>
                </div>
                <div class="results-grid" id="resultsGrid"></div>
                <div class="images-gallery" id="imagesGallery" style="display: none;">
                    <h3 style="color: #ff00ff; margin-bottom: 15px; text-align: center;" id="galleryTitle">–°–ì–ï–ù–ï–†–ò–†–û–í–ê–ù–ù–´–ï –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø</h3>
                    <div class="gallery-grid" id="galleryGrid"></div>
                </div>
                <div class="report-section" id="reportSection">
                    <h3 style="color: #ff00ff; margin-bottom: 10px;" id="reportTitle">–¢–ï–ö–°–¢–û–í–´–ô –û–¢–ß–Å–¢</h3>
                    <div id="reportText"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentImage = null;
        let currentLanguage = localStorage.getItem('skinAnalyzerLanguage') || 'ru';
        let currentMode = 'pixelbin';
        let sam3Timeout = 5;
        const SAM3_DISEASES = [
            {key: "acne", name: "–ê–∫–Ω–µ"},
            {key: "pimples", name: "–ü—Ä—ã—â–∏"},
            {key: "pustules", name: "–ü—É—Å—Ç—É–ª—ã"},
            {key: "papules", name: "–ü–∞–ø—É–ª—ã"},
            {key: "blackheads", name: "–ß–µ—Ä–Ω—ã–µ —Ç–æ—á–∫–∏"},
            {key: "whiteheads", name: "–ë–µ–ª—ã–µ —É–≥—Ä–∏"},
            {key: "comedones", name: "–ö–æ–º–µ–¥–æ–Ω—ã"},
            {key: "rosacea", name: "–†–æ–∑–∞—Ü–µ–∞"},
            {key: "irritation", name: "–†–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ"},
            {key: "pigmentation", name: "–ü–∏–≥–º–µ–Ω—Ç–∞—Ü–∏—è"},
            {key: "freckles", name: "–í–µ—Å–Ω—É—à–∫–∏"},
            {key: "papillomas", name: "–ü–∞–ø–∏–ª–ª–æ–º—ã"},
            {key: "warts", name: "–ë–æ—Ä–æ–¥–∞–≤–∫–∏"},
            {key: "moles", name: "–†–æ–¥–∏–Ω–∫–∏"},
            {key: "skin tags", name: "–ö–æ–∂–Ω—ã–µ –≤—ã—Ä–æ—Å—Ç—ã"},
            {key: "wrinkles", name: "–ú–æ—Ä—â–∏–Ω—ã"},
            {key: "fine lines", name: "–ú–µ–ª–∫–∏–µ –º–æ—Ä—â–∏–Ω—ã"},
            {key: "skin lesion", name: "–ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è"},
            {key: "scars", name: "–®—Ä–∞–º—ã"},
            {key: "post acne marks", name: "–°–ª–µ–¥—ã –ø–æ—Å—Ç–∞–∫–Ω–µ"},
            {key: "acne scars", name: "–®—Ä–∞–º—ã –æ—Ç –∞–∫–Ω–µ"},
        ];

        // Translations
        const translations = {
            ru: {
                settings: '–ù–ê–°–¢–†–û–ô–ö–ò',
                language: 'EN',
                settingsTitle: '–ù–ê–°–¢–†–û–ô–ö–ò –ú–û–î–ï–õ–ò',
                detectionProvider: '–ü–†–û–í–ê–ô–î–ï–† –î–ï–¢–ï–ö–¶–ò–ò',
                visionModel: '–ú–û–î–ï–õ–¨ –í–ò–ó–ò–ò',
                llmProvider: '–ü–†–û–í–ê–ô–î–ï–† LLM',
                textModel: '–¢–ï–ö–°–¢–û–í–ê–Ø –ú–û–î–ï–õ–¨',
                temperature: '–¢–ï–ú–ü–ï–†–ê–¢–£–†–ê:',
                maxTokens: 'MAX TOKENS:',
                save: '–°–û–•–†–ê–ù–ò–¢–¨',
                uploadTitle: '–ó–ê–ì–†–£–ó–ò–¢–¨ –§–û–¢–û',
                uploadInfo: '–ü–ï–†–ï–¢–ê–©–ò–¢–ï –ò–õ–ò –ù–ê–ñ–ú–ò–¢–ï –ö–ù–û–ü–ö–£',
                selectFile: '–í–´–ë–†–ê–¢–¨ –§–ê–ô–õ',
                reset: '–°–ë–†–û–°–ò–¢–¨',
                analyze: '–ê–ù–ê–õ–ò–ó–ò–†–û–í–ê–¢–¨',
                analyzing: '–ê–ù–ê–õ–ò–ó–ò–†–£–Æ...',
                reportTitle: '–¢–ï–ö–°–¢–û–í–´–ô –û–¢–ß–Å–¢',
                error: '–û–®–ò–ë–ö–ê:',
                loadImage: '–ó–ê–ì–†–£–ó–ò–¢–ï –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ï',
                pleaseSelectImage: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',
                analysisError: '–û–®–ò–ë–ö–ê –ê–ù–ê–õ–ò–ó–ê',
                details: '–î–µ—Ç–∞–ª–∏:',
                openrouterKeyNotFound: 'OPENROUTER_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω',
                invalidFormat: '–ù–ï–í–ï–†–ù–´–ô –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê',
                settingsSaved: '–ù–ê–°–¢–†–û–ô–ö–ò –°–û–•–†–ê–ù–ï–ù–´',
                acne: '–ê–ö–ù–ï',
                pigmentation: '–ü–ò–ì–ú–ï–ù–¢–ê–¶–ò–Ø',
                pores: '–†–ê–ó–ú–ï–† –ü–û–†',
                wrinkles: '–ú–û–†–©–ò–ù–´',
                skinTone: '–¢–û–ù –ö–û–ñ–ò',
                texture: '–¢–ï–ö–°–¢–£–†–ê',
                moisture: '–£–í–õ–ê–ñ–ù–ï–ù–ù–û–°–¢–¨',
                oiliness: '–ñ–ò–†–ù–û–°–¢–¨',
                high: '–í–´–°–û–ö–ò–ô',
                medium: '–°–†–ï–î–ù–ò–ô',
                low: '–ù–ò–ó–ö–ò–ô',
                headerTitle: 'SKIN ANALYZER',
                headerSubtitle: 'DETECT DISEASE TYPE',
                galleryTitle: '–°–ì–ï–ù–ï–†–ò–†–û–í–ê–ù–ù–´–ï –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø'
            },
            en: {
                settings: 'SETTINGS',
                language: 'RU',
                settingsTitle: 'MODEL SETTINGS',
                detectionProvider: 'DETECTION PROVIDER',
                visionModel: 'VISION MODEL',
                llmProvider: 'LLM PROVIDER',
                textModel: 'TEXT MODEL',
                temperature: 'TEMPERATURE:',
                maxTokens: 'MAX TOKENS:',
                save: 'SAVE',
                uploadTitle: 'UPLOAD PHOTO',
                uploadInfo: 'DRAG AND DROP OR CLICK BUTTON',
                selectFile: 'SELECT FILE',
                reset: 'RESET',
                analyze: 'ANALYZE',
                analyzing: 'ANALYZING...',
                reportTitle: 'TEXT REPORT',
                error: 'ERROR:',
                loadImage: 'LOAD IMAGE',
                pleaseSelectImage: 'Please select an image',
                analysisError: 'ANALYSIS ERROR',
                details: 'Details:',
                openrouterKeyNotFound: 'OPENROUTER_API_KEY not found',
                invalidFormat: 'INVALID RESPONSE FORMAT',
                settingsSaved: 'SETTINGS SAVED',
                acne: 'ACNE',
                pigmentation: 'PIGMENTATION',
                pores: 'PORES SIZE',
                wrinkles: 'WRINKLES',
                skinTone: 'SKIN TONE',
                texture: 'TEXTURE',
                moisture: 'MOISTURE',
                oiliness: 'OILINESS',
                high: 'HIGH',
                medium: 'MEDIUM',
                low: 'LOW',
                headerTitle: 'SKIN ANALYZER',
                headerSubtitle: 'DETECT DISEASE TYPE'
            }
        };

        function openModeModal() {
            const modal = document.getElementById('modeModal');
            if (modal) modal.style.display = 'flex';
        }

        function closeModeModal() {
            const modal = document.getElementById('modeModal');
            if (modal) modal.style.display = 'none';
        }

        function selectMode(mode) {
            currentMode = mode;
            closeModeModal();
            const sam3Controls = document.getElementById('sam3Controls');
            if (sam3Controls) {
                sam3Controls.style.display = (mode === 'sam3') ? 'block' : 'none';
            }
        }

        function updateSam3Timeout(val) {
            sam3Timeout = parseInt(val);
            const el = document.getElementById('sam3TimeoutValue');
            if (el) el.textContent = val;
        }

        function renderSam3Diseases() {
            const container = document.getElementById('sam3DiseasesList');
            if (!container) return;
            container.innerHTML = '';
            SAM3_DISEASES.forEach(item => {
                const label = document.createElement('label');
                label.style.display = 'flex';
                label.style.alignItems = 'center';
                label.style.gap = '6px';
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.value = item.key;
                cb.checked = true;
                label.appendChild(cb);
                label.appendChild(document.createTextNode(item.name));
                container.appendChild(label);
            });
        }

        function getSelectedSam3Diseases() {
            const container = document.getElementById('sam3DiseasesList');
            if (!container) return [];
            return Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
        }

        function setStatusLog(statuses) {
            const wrap = document.getElementById('statusLogContainer');
            const pre = document.getElementById('statusLog');
            if (!wrap || !pre) return;
            if (statuses && statuses.length > 0) {
                pre.textContent = statuses.join('\n');
                wrap.style.display = 'block';
            } else {
                pre.textContent = '';
                wrap.style.display = 'none';
            }
        }

        function t(key) {
            return translations[currentLanguage][key] || key;
        }

        function toggleLanguage() {
            currentLanguage = currentLanguage === 'ru' ? 'en' : 'ru';
            localStorage.setItem('skinAnalyzerLanguage', currentLanguage);
            currentConfig.language = currentLanguage;
            updateLanguage();
        }

        function updateLanguage() {
            // Update button text
            document.getElementById('languageBtn').textContent = 'üåê ' + t('language');
            document.getElementById('settingsBtn').textContent = '‚öôÔ∏è ' + t('settings');
            
            // Update header
            document.getElementById('headerTitle').textContent = t('headerTitle');
            document.getElementById('headerSubtitle').textContent = t('headerSubtitle');
            
            // Update settings panel
            document.getElementById('settingsTitle').textContent = t('settingsTitle');
            document.getElementById('detectionProviderLabel').textContent = t('detectionProvider');
            document.getElementById('visionModelLabel').textContent = t('visionModel');
            document.getElementById('llmProviderLabel').textContent = t('llmProvider');
            document.getElementById('textModelLabel').textContent = t('textModel');
            document.getElementById('temperatureLabel').innerHTML = t('temperature') + ' <span class="setting-value" id="tempValue">' + document.getElementById('tempValue').textContent + '</span>';
            document.getElementById('maxTokensLabel').innerHTML = t('maxTokens') + ' <span class="setting-value" id="tokensValue">' + document.getElementById('tokensValue').textContent + '</span>';
            document.getElementById('saveSettingsBtn').textContent = t('save');
            
            // Update main content
            document.getElementById('uploadTitle').textContent = t('uploadTitle');
            document.getElementById('uploadInfo').textContent = t('uploadInfo');
            document.getElementById('selectFileBtn').textContent = t('selectFile');
            document.getElementById('resetBtn').textContent = t('reset');
            document.getElementById('analyzeBtn').textContent = t('analyze');
            document.getElementById('loadingText').textContent = t('analyzing');
            document.getElementById('reportTitle').textContent = t('reportTitle');
            const galleryTitle = document.getElementById('galleryTitle');
            if (galleryTitle) {
                galleryTitle.textContent = t('galleryTitle');
            }
            document.getElementById('previewImage').alt = currentLanguage === 'ru' ? '–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä' : 'Preview';
            
            // Update page title
            document.title = currentLanguage === 'ru' ? '–ê–Ω–∞–ª–∏–∑ –∫–æ–∂–∏ - Detect Skin' : 'Skin Analysis - Detect Skin';
            document.documentElement.lang = currentLanguage;
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
        const fileInput = document.getElementById('fileInput');
        const uploadSection = document.getElementById('uploadSection');
        const previewSection = document.getElementById('previewSection');
        const previewImage = document.getElementById('previewImage');
        const analyzeBtn = document.getElementById('analyzeBtn');

        fileInput.addEventListener('change', handleFileSelect);

        // Drag and Drop
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        async function handleFile(file) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞ - –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ HEIC/HEIF
            const isImage = file.type.startsWith('image/');
            const isHeic = file.name.toLowerCase().endsWith('.heic') || 
                          file.name.toLowerCase().endsWith('.heif') ||
                          file.type === 'image/heic' || 
                          file.type === 'image/heif' ||
                          file.type === '';
            
            if (!isImage && !isHeic) {
                showError(t('pleaseSelectImage'));
                return;
            }
            
            // –î–ª—è HEIC —Ñ–∞–π–ª–æ–≤ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ JPEG –¥–ª—è preview
            if (isHeic && !isImage && typeof heic2any !== 'undefined') {
                try {
                    console.log('–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è HEIC —Ñ–∞–π–ª–∞ –¥–ª—è preview:', file.name);
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                    const loadingText = document.getElementById('loadingText');
                    const originalText = loadingText.textContent;
                    loadingText.textContent = '–ö–û–ù–í–ï–†–¢–ê–¶–ò–Ø HEIC...';
                    document.getElementById('loading').classList.add('show');
                    
                    // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º HEIC –≤ JPEG
                    const convertedBlob = await heic2any({
                        blob: file,
                        toType: 'image/jpeg',
                        quality: 0.9
                    });
                    
                    // heic2any –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å –º–∞—Å—Å–∏–≤, –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç
                    const blob = Array.isArray(convertedBlob) ? convertedBlob[0] : convertedBlob;
                    
                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π File –æ–±—ä–µ–∫—Ç –∏–∑ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ blob
                    const convertedFile = new File([blob], file.name.replace(/\.(heic|heif)$/i, '.jpg'), {
                        type: 'image/jpeg',
                        lastModified: file.lastModified
                    });
                    
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª
                    file = convertedFile;
                    console.log('HEIC —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –≤ JPEG');
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                    document.getElementById('loading').classList.remove('show');
                    loadingText.textContent = originalText;
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ HEIC:', error);
                    showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ HEIC —Ñ–∞–π–ª–∞. –§–∞–π–ª –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏.');
                    document.getElementById('loading').classList.remove('show');
                    // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º —Ñ–∞–π–ª–æ–º
                }
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                currentImage = e.target.result;
                previewImage.src = currentImage;
                uploadSection.style.display = 'none';
                previewSection.style.display = 'block';
                document.getElementById('resultsSection').classList.remove('show');
                document.getElementById('errorMessage').classList.remove('show');
            };
            reader.onerror = (error) => {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞:', error);
                showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞');
            };
            reader.readAsDataURL(file);
        }

        function resetImage() {
            currentImage = null;
            previewImage.src = '';
            fileInput.value = '';
            uploadSection.style.display = 'block';
            previewSection.style.display = 'none';
            document.getElementById('resultsSection').classList.remove('show');
            document.getElementById('errorMessage').classList.remove('show');
            document.getElementById('imagesGallery').style.display = 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = t('error') + ' ' + message;
            errorDiv.classList.add('show');
            setTimeout(() => {
                errorDiv.classList.remove('show');
            }, 5000);
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            let currentConfig = {
            detection_provider: 'openrouter',
            llm_provider: 'openrouter',
            vision_model: 'google/gemini-2.0-flash-001',
            text_model: 'anthropic/claude-3.5-sonnet',
            temperature: 0,
            max_tokens: 300,
            language: currentLanguage
        };

        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('open');
        }

        function updateTempValue(value) {
            document.getElementById('tempValue').textContent = value;
            currentConfig.temperature = parseFloat(value);
        }

        function updateTokensValue(value) {
            document.getElementById('tokensValue').textContent = value;
            currentConfig.max_tokens = parseInt(value);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π —Å backend
        let availableModels = {
            openrouter: { vision: [], text: [] }
        };

        async function loadAvailableModels() {
            try {
                const response = await fetch('/api/models/available');
                const data = await response.json();
                if (data.success) {
                    availableModels = data.models;
                    updateModelOptions();
                    console.log('–ú–æ–¥–µ–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', availableModels);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–µ–π:', error);
            }
        }

        function updateModelOptions() {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π –¥–ª—è vision
            const visionModelSelect = document.getElementById('visionModel');
            const currentVisionValue = visionModelSelect.value || 'google/gemini-2.0-flash-001';
            visionModelSelect.innerHTML = '';
            
            const detectionProvider = document.getElementById('detectionProvider').value;
            const models = availableModels[detectionProvider]?.vision || [];
            
            let visionModelSet = false;
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.value;
                option.textContent = model.label;
                if (model.value === currentVisionValue) {
                    option.selected = true;
                    visionModelSet = true;
                }
                visionModelSelect.appendChild(option);
            });
            
            // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∞—è –º–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–æ–¥–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            if (!visionModelSet && models.length > 0) {
                const defaultModel = 'google/gemini-2.0-flash-001';
                const defaultOption = visionModelSelect.querySelector(`option[value="${defaultModel}"]`);
                if (defaultOption) {
                    defaultOption.selected = true;
                    currentConfig.vision_model = defaultModel;
                } else if (models.length > 0) {
                    visionModelSelect.options[0].selected = true;
                    currentConfig.vision_model = visionModelSelect.options[0].value;
                }
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π –¥–ª—è text
            const textModelSelect = document.getElementById('textModel');
            const currentTextValue = textModelSelect.value || 'anthropic/claude-3.5-sonnet';
            textModelSelect.innerHTML = '';
            
            const llmProvider = document.getElementById('llmProvider').value;
            const textModels = availableModels[llmProvider]?.text || [];
            
            let textModelSet = false;
            textModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model.value;
                option.textContent = model.label;
                if (model.value === currentTextValue) {
                    option.selected = true;
                    textModelSet = true;
                }
                textModelSelect.appendChild(option);
            });
            
            // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∞—è –º–æ–¥–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–æ–¥–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            if (!textModelSet && textModels.length > 0) {
                const defaultModel = 'anthropic/claude-3.5-sonnet';
                const defaultOption = textModelSelect.querySelector(`option[value="${defaultModel}"]`);
                if (defaultOption) {
                    defaultOption.selected = true;
                    currentConfig.text_model = defaultModel;
                } else if (textModels.length > 0) {
                    textModelSelect.options[0].selected = true;
                    currentConfig.text_model = textModelSelect.options[0].value;
                }
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–¥–µ–ª–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
        document.getElementById('detectionProvider').addEventListener('change', updateModelOptions);
        document.getElementById('llmProvider').addEventListener('change', updateModelOptions);

        function saveSettings() {
            currentConfig.detection_provider = document.getElementById('detectionProvider').value;
            currentConfig.llm_provider = document.getElementById('llmProvider').value;
            currentConfig.vision_model = document.getElementById('visionModel').value;
            currentConfig.text_model = document.getElementById('textModel').value;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            localStorage.setItem('skinAnalyzerConfig', JSON.stringify(currentConfig));
            
            alert(t('settingsSaved'));
        }

        async function loadSettings() {
            const saved = localStorage.getItem('skinAnalyzerConfig');
            if (saved) {
                currentConfig = JSON.parse(saved);
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —è–∑—ã–∫ –∏–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–ª–∏ –∏–∑ localStorage
            if (currentConfig.language) {
                currentLanguage = currentConfig.language;
            } else {
                currentLanguage = localStorage.getItem('skinAnalyzerLanguage') || 'ru';
                currentConfig.language = currentLanguage;
            }
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ UI
            document.getElementById('detectionProvider').value = currentConfig.detection_provider;
            document.getElementById('llmProvider').value = currentConfig.llm_provider;
            document.getElementById('temperature').value = currentConfig.temperature || 0;
            document.getElementById('maxTokens').value = currentConfig.max_tokens || 300;
            updateTempValue(currentConfig.temperature || 0);
            updateTokensValue(currentConfig.max_tokens || 300);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–¥–µ–ª–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–µ–π, –µ—Å–ª–∏ –æ–Ω–∏ –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
            if (availableModels.openrouter.vision.length === 0) {
                await loadAvailableModels();
            }
            updateModelOptions();
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–ø—Ü–∏–π
            const visionSelect = document.getElementById('visionModel');
            const textSelect = document.getElementById('textModel');
            
            if (currentConfig.vision_model && visionSelect.querySelector(`option[value="${currentConfig.vision_model}"]`)) {
                visionSelect.value = currentConfig.vision_model;
            } else if (visionSelect.options.length > 0) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–¥–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                const defaultVision = 'google/gemini-2.0-flash-001';
                if (visionSelect.querySelector(`option[value="${defaultVision}"]`)) {
                    visionSelect.value = defaultVision;
                    currentConfig.vision_model = defaultVision;
                } else if (visionSelect.options.length > 0) {
                    visionSelect.options[0].selected = true;
                    currentConfig.vision_model = visionSelect.options[0].value;
                }
            }
            
            if (currentConfig.text_model && textSelect.querySelector(`option[value="${currentConfig.text_model}"]`)) {
                textSelect.value = currentConfig.text_model;
            } else if (textSelect.options.length > 0) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–¥–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                const defaultText = 'anthropic/claude-3.5-sonnet';
                if (textSelect.querySelector(`option[value="${defaultText}"]`)) {
                    textSelect.value = defaultText;
                    currentConfig.text_model = defaultText;
                } else if (textSelect.options.length > 0) {
                    textSelect.options[0].selected = true;
                    currentConfig.text_model = textSelect.options[0].value;
                }
            }
        }

        function analyzeSkin() {
            if (!currentImage) {
                showError(t('loadImage'));
                return;
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥ –∏–∑ UI –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
            currentConfig.detection_provider = document.getElementById('detectionProvider').value;
            currentConfig.llm_provider = document.getElementById('llmProvider').value;
            currentConfig.vision_model = document.getElementById('visionModel').value;
            currentConfig.text_model = document.getElementById('textModel').value;
            currentConfig.temperature = parseFloat(document.getElementById('temperature').value);
            currentConfig.max_tokens = parseInt(document.getElementById('maxTokens').value);
            currentConfig.language = currentLanguage;  // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —è–∑—ã–∫

            // SAM3 –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            const sam3TimeoutValue = parseInt(document.getElementById('sam3Timeout').value || sam3Timeout);
            const sam3Selected = getSelectedSam3Diseases();
            setStatusLog([]); // –æ—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥ –ø–µ—Ä–µ–¥ –Ω–æ–≤—ã–º –∑–∞–ø—Ä–æ—Å–æ–º

            console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —Å –∫–æ–Ω—Ñ–∏–≥–æ–º:', currentConfig);

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            document.getElementById('loading').classList.add('show');
            analyzeBtn.disabled = true;
            document.getElementById('resultsSection').classList.remove('show');
            document.getElementById('errorMessage').classList.remove('show');
            document.getElementById('reportSection').classList.remove('show');
            document.getElementById('imagesGallery').style.display = 'none';

            // –†–µ–∞–ª—å–Ω—ã–π API –≤—ã–∑–æ–≤
            fetch('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    image: currentImage,
                    config: currentConfig,
                    mode: currentMode,
                    sam3_timeout: sam3TimeoutValue,
                    sam3_diseases: sam3Selected
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || `HTTP ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (!data.success) {
                    let errorMsg = data.error || t('analysisError');
                    if (data.details) {
                        errorMsg += '\n\n' + t('details');
                        if (data.details.openrouter_available === false) {
                            errorMsg += '\n- ' + t('openrouterKeyNotFound');
                        }
                    }
                    showError(errorMsg);
                    document.getElementById('loading').classList.remove('show');
                    analyzeBtn.disabled = false;
                    return;
                }

                if (data.data) {
                    displayResults(data.data);
                    
                    const sam3Item = data.pixelbin_images && data.pixelbin_images.find(img => img.type === 'sam3');

                    if (sam3Item) {
                        // SAM3 —Ä–µ–∂–∏–º
                        setStatusLog(sam3Item.statuses || []);
                        displaySam3Masks(sam3Item.sam3_results || {});
                    } else {
                        setStatusLog([]);
                    }

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–∏ —ç–≤—Ä–∏—Å—Ç–∏–∫–∞
                    if (data.analysis_method && String(data.analysis_method).includes('sam3')) {
                        // –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, —Å–∞–º3 —É–∂–µ –æ—Ç–æ–±—Ä–∞–∂—ë–Ω
                    } else if (data.use_heuristics) {
                        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–µ—Ç–æ–¥–∞—Ö
                        let methodsInfo = "–ü—Ä–æ—Å—Ç—ã–µ —ç–≤—Ä–∏—Å—Ç–∏–∫–∏";
                        let methodsList = [];
                        
                        if (data.pixelbin_images && data.pixelbin_images.length > 0) {
                            const heuristicItem = data.pixelbin_images.find(img => img.type === 'heuristic');
                            if (heuristicItem) {
                                if (heuristicItem.primary_method) {
                                    methodsInfo = heuristicItem.primary_method;
                                }
                                if (heuristicItem.methods_used && heuristicItem.methods_used.length > 0) {
                                    methodsList = heuristicItem.methods_used;
                                } else if (heuristicItem.heuristic_data && heuristicItem.heuristic_data.methods_used) {
                                    methodsList = heuristicItem.heuristic_data.methods_used;
                                    methodsInfo = heuristicItem.heuristic_data.primary_method || methodsInfo;
                                }
                            }
                        }
                        
                        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                        let message = "Pixelbin API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.<br>";
                        if (data.analysis_method) {
                            message += `–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è: ${data.analysis_method}.<br>`;
                        } else {
                            message += "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —ç–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑.<br>";
                        }
                        message += "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–æ–≥—É—Ç –±—ã—Ç—å –º–µ–Ω–µ–µ —Ç–æ—á–Ω—ã–º–∏.";
                        
                        showHeuristicModal(message, methodsList, methodsInfo);
                        
                        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —ç–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏
                        if (data.pixelbin_images && data.pixelbin_images.length > 0) {
                            const heuristicItem = data.pixelbin_images.find(img => img.type === 'heuristic');
                            if (heuristicItem && heuristicItem.heuristic_data) {
                                displayHeuristicMarkers(heuristicItem.heuristic_data);
                            }
                        }
                    } else if (!sam3Item) {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–∞–ª–µ—Ä–µ—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–∑ Pixelbin, –µ—Å–ª–∏ –µ—Å—Ç—å
                        if (data.pixelbin_images && data.pixelbin_images.length > 0) {
                            displayImageGallery(data.pixelbin_images);
                        } else {
                            document.getElementById('imagesGallery').style.display = 'none';
                        }
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á—ë—Ç –µ—Å–ª–∏ –µ—Å—Ç—å
                    if (data.report) {
                        document.getElementById('reportText').textContent = data.report;
                        document.getElementById('reportSection').classList.add('show');
                    }
                    
                    console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:', data.data);
                    if (data.pixelbin_images) {
                        console.log('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è Pixelbin:', data.pixelbin_images);
                    }
                } else {
                    showError(t('invalidFormat'));
                }
                
                document.getElementById('loading').classList.remove('show');
                analyzeBtn.disabled = false;
            })
            .catch(error => {
                showError(t('analysisError') + ': ' + error.message);
                document.getElementById('loading').classList.remove('show');
                analyzeBtn.disabled = false;
            });
        }

        function displayResults(results) {
            const resultsGrid = document.getElementById('resultsGrid');
            resultsGrid.innerHTML = '';

            const resultConfig = {
                acne_score: { label: t('acne'), unit: '%' },
                pigmentation_score: { label: t('pigmentation'), unit: '%' },
                pores_size: { label: t('pores'), unit: '%' },
                wrinkles_grade: { label: t('wrinkles'), unit: '%' },
                skin_tone: { label: t('skinTone'), unit: '%' },
                texture_score: { label: t('texture'), unit: '%' },
                moisture_level: { label: t('moisture'), unit: '%' },
                oiliness: { label: t('oiliness'), unit: '%' }
            };

            for (const [key, value] of Object.entries(results)) {
                if (resultConfig[key]) {
                    const config = resultConfig[key];
                    const roundedValue = Math.round(value * 100) / 100;
                    const grade = getGrade(value);

                    const card = document.createElement('div');
                    card.className = 'result-card';
                    card.innerHTML = `
                        <div class="result-label">${config.label}</div>
                        <div class="result-value">${roundedValue}${config.unit}</div>
                        <div class="result-grade ${grade.class}">${grade.text}</div>
                    `;
                    resultsGrid.appendChild(card);
                }
            }

            document.getElementById('resultsSection').classList.add('show');
        }

        function getGrade(value) {
            if (value >= 70) {
                return { class: 'high', text: t('high') };
            } else if (value >= 40) {
                return { class: 'medium', text: t('medium') };
            } else {
                return { class: 'low', text: t('low') };
            }
        }

        function displayImageGallery(images) {
            const galleryGrid = document.getElementById('galleryGrid');
            const gallerySection = document.getElementById('imagesGallery');
            
            if (!images || images.length === 0) {
                gallerySection.style.display = 'none';
                return;
            }
            
            galleryGrid.innerHTML = '';
            
            images.forEach((image, index) => {
                const item = document.createElement('div');
                item.className = 'gallery-item';
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
                let metaText = '';
                if (image.concern_name) {
                    metaText = `${image.concern_name}: ${image.value} (${image.severity || ''})`;
                } else if (image.type === 'zone') {
                    metaText = image.title.split('(')[1]?.replace(')', '') || '';
                } else if (image.type) {
                    metaText = image.type;
                }
                
                // –°–æ–∑–¥–∞—ë–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏
                const img = document.createElement('img');
                img.className = 'gallery-image';
                img.alt = image.title;
                img.loading = 'lazy';
                img.referrerPolicy = 'no-referrer';
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º proxy –¥–ª—è –æ–±—Ö–æ–¥–∞ CORS, –µ—Å–ª–∏ URL –æ—Ç Pixelbin
                const imageUrl = image.url && image.url.includes('pixelbin.io') 
                    ? `/api/proxy-image?url=${encodeURIComponent(image.url)}`
                    : image.url;
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º src –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ –¥–ª—è –ª—É—á—à–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫
                img.src = imageUrl;
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏
                img.onerror = function() {
                    console.warn(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ${image.title}`, image.url);
                    this.src = 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22%3E%3Crect fill=%22%23000%22 width=%22200%22 height=%22200%22/%3E%3Ctext fill=%22%23fff%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2212%22%3E–û—à–∏–±–∫–∞%3C/text%3E%3Ctext fill=%22%23fff%22 x=%2250%25%22 y=%2265%25%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2210%22%3E–∑–∞–≥—Ä—É–∑–∫–∏%3C/text%3E%3C/svg%3E';
                    this.onerror = null; // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª
                };
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
                img.onload = function() {
                    console.log(`–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: ${image.title}`);
                };
                
                // –°–æ–∑–¥–∞—ë–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–µ–∫—Å—Ç–∞
                const titleDiv = document.createElement('div');
                titleDiv.className = 'gallery-title';
                titleDiv.textContent = image.title;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –µ—Å—Ç—å
                if (metaText) {
                    const metaDiv = document.createElement('div');
                    metaDiv.className = 'gallery-meta';
                    metaDiv.textContent = metaText;
                    item.appendChild(metaDiv);
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
                item.appendChild(img);
                item.appendChild(titleDiv);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π URL –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –≤ –ø–æ–ª–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ
                const originalUrl = image.url;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –≤ –ø–æ–ª–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ
                item.addEventListener('click', () => {
                    window.open(originalUrl, '_blank');
                });
                
                galleryGrid.appendChild(item);
            });
            
            gallerySection.style.display = 'block';
        }

        function showHeuristicModal(message, methodsList, primaryMethod) {
            const modal = document.getElementById('heuristicModal');
            const messageEl = document.getElementById('heuristicModalMessage');
            const methodsTextEl = document.getElementById('methodsText');
            
            if (messageEl) {
                messageEl.innerHTML = message || "Pixelbin API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.<br>–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —ç–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑.<br>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–æ–≥—É—Ç –±—ã—Ç—å –º–µ–Ω–µ–µ —Ç–æ—á–Ω—ã–º–∏.";
            }
            
            if (methodsTextEl) {
                if (methodsList && methodsList.length > 0) {
                    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –º–µ—Ç–æ–¥–æ–≤ —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º
                    let methodsHtml = "";
                    methodsList.forEach((method, index) => {
                        const isPrimary = (index === 0) || (method === primaryMethod);
                        const prefix = isPrimary ? "‚Üí " : "  ";
                        const style = isPrimary ? "color: #ff00ff; font-weight: bold;" : "color: #00ffff;";
                        methodsHtml += `<span style="${style}">${prefix}${method}</span><br>`;
                    });
                    methodsTextEl.innerHTML = methodsHtml;
                } else {
                    methodsTextEl.textContent = primaryMethod || "–ü—Ä–æ—Å—Ç—ã–µ —ç–≤—Ä–∏—Å—Ç–∏–∫–∏";
                }
            }
            
            modal.style.display = 'flex';
        }

        function closeHeuristicModal() {
            document.getElementById('heuristicModal').style.display = 'none';
        }

        function displaySam3Masks(sam3Results) {
            const gallerySection = document.getElementById('imagesGallery');
            const grid = document.getElementById('galleryGrid');
            const title = document.getElementById('galleryTitle');
            if (!gallerySection || !grid || !title) return;
            grid.innerHTML = '';

            const entries = Object.entries(sam3Results || {});
            entries.forEach(([disease, result]) => {
                const card = document.createElement('div');
                card.className = 'image-card';

                const header = document.createElement('div');
                header.className = 'image-title';
                header.textContent = disease;
                card.appendChild(header);

                if (result && result.masks && result.masks.length > 0) {
                    result.masks.forEach(mask => {
                        if (!mask.url) return;
                        const img = document.createElement('img');
                        img.src = mask.url;
                        img.alt = `${disease} mask`;
                        img.style.width = '100%';
                        img.style.objectFit = 'contain';
                        card.appendChild(img);
                    });
                } else {
                    const empty = document.createElement('p');
                    empty.style.color = '#00ffff';
                    empty.style.fontSize = '0.7em';
                    empty.textContent = '–ú–∞—Å–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
                    card.appendChild(empty);
                }

                grid.appendChild(card);
            });

            if (entries.length > 0) {
                gallerySection.style.display = 'block';
                title.textContent = 'SAM3 –ú–ê–°–ö–ò';
            } else {
                gallerySection.style.display = 'none';
            }
        }

        function displayHeuristicMarkers(heuristicData) {
            const previewImage = document.getElementById('previewImage');
            if (!previewImage || !previewImage.src) return;

            // –°–æ–∑–¥–∞—ë–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤
            const previewSection = document.getElementById('previewSection');
            let markersContainer = document.getElementById('heuristicMarkersContainer');
            
            if (!markersContainer) {
                markersContainer = document.createElement('div');
                markersContainer.id = 'heuristicMarkersContainer';
                markersContainer.className = 'heuristic-markers';
                markersContainer.style.position = 'relative';
                markersContainer.style.display = 'inline-block';
                
                // –û–±—ë—Ä—Ç—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                const parent = previewImage.parentNode;
                parent.insertBefore(markersContainer, previewImage);
                markersContainer.appendChild(previewImage);
            }

            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –º–∞—Ä–∫–µ—Ä—ã
            const oldMarkers = markersContainer.querySelectorAll('.heuristic-marker');
            oldMarkers.forEach(m => m.remove());

            // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–π –ø—Ä–æ–±–ª–µ–º—ã
            if (heuristicData.concerns && heuristicData.concerns.length > 0) {
                const addMarkers = function() {
                    const imgWidth = previewImage.offsetWidth;
                    const imgHeight = previewImage.offsetHeight;

                    heuristicData.concerns.forEach((concern, index) => {
                        const marker = document.createElement('div');
                        marker.title = `${concern.name}: ${concern.description}`;
                        
                        const isArea = concern.is_area || (concern.position && concern.position.type === 'area');
                        const isDot = concern.is_dot || (concern.position && concern.position.marker_type === 'dot');
                        const isWrinkle = concern.position && concern.position.shape === 'wrinkle';
                        
                        if (isDot) {
                            // –ü–∏–≥–º–µ–Ω—Ç–∞—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–∞–∫ —Ç–æ—á–∫–∏
                            marker.className = 'heuristic-marker dot-marker';
                            marker.style.left = `${concern.position.x}%`;
                            marker.style.top = `${concern.position.y}%`;
                            marker.style.width = '8px';
                            marker.style.height = '8px';
                            marker.style.borderRadius = '50%';
                            marker.style.backgroundColor = '#ff0080';
                            marker.style.border = '2px solid #00ffff';
                            marker.style.boxShadow = '0 0 8px rgba(255,0,128,0.8)';
                            marker.style.transform = 'translate(-50%, -50%)';
                        } else if (isArea) {
                            // –°–æ–∑–¥–∞—ë–º –æ–±–ª–∞—Å—Ç—å –¥–ª—è –º–æ—Ä—â–∏–Ω —Å –∏—Ö —Ñ–æ—Ä–º–æ–π
                            const shape = concern.position.shape || 'ellipse';
                            marker.className = `heuristic-marker area-marker ${shape}`;
                            marker.style.left = `${concern.position.x - (concern.position.width || 0) / 2}%`;
                            marker.style.top = `${concern.position.y - (concern.position.height || 0) / 2}%`;
                            marker.style.width = `${concern.position.width || 20}%`;
                            marker.style.height = `${concern.position.height || 20}%`;
                            
                            // –î–ª—è –º–æ—Ä—â–∏–Ω –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ —Ç–æ—á–Ω—É—é —Ñ–æ—Ä–º—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç
                            if (shape === 'wrinkle' || isWrinkle) {
                                // –ú–æ—Ä—â–∏–Ω—ã - —É–∑–∫–∏–µ –≤—ã—Ç—è–Ω—É—Ç—ã–µ –æ–±–ª–∞—Å—Ç–∏
                                marker.style.borderRadius = '50%';
                                marker.style.transform = 'rotate(-45deg)';
                            } else if (shape === 'ellipse') {
                                marker.style.borderRadius = '50%';
                            } else if (shape === 'polygon') {
                                // –°–æ–∑–¥–∞—ë–º –æ—Ä–≥–∞–Ω–∏—á–Ω—É—é —Ñ–æ—Ä–º—É –º–Ω–æ–≥–æ—É–≥–æ–ª—å–Ω–∏–∫–∞, –ø–æ—Ö–æ–∂—É—é –Ω–∞ –∫–æ–Ω—Ç—É—Ä—ã –ª–∏—Ü–∞
                                const points = [
                                    '20% 10%', '80% 15%', '95% 30%', '100% 60%',
                                    '90% 85%', '70% 95%', '30% 90%', '10% 70%',
                                    '5% 40%', '10% 20%'
                                ].join(', ');
                                marker.style.clipPath = `polygon(${points})`;
                            }
                        } else {
                            // –°–æ–∑–¥–∞—ë–º –ø—è—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫ –¥–ª—è –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–±–ª–µ–º (–∞–∫–Ω–µ, –ø–æ—Ä—ã)
                            marker.className = 'heuristic-marker point-marker';
                            marker.style.left = `${concern.position.x}%`;
                            marker.style.top = `${concern.position.y}%`;
                            
                            // –°–æ–∑–¥–∞—ë–º SVG –ø—è—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫
                            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                            svg.setAttribute('width', '30');
                            svg.setAttribute('height', '30');
                            svg.setAttribute('viewBox', '0 0 30 30');
                            
                            // –ü—è—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫ (–ø–µ–Ω—Ç–∞–≥–æ–Ω) - –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ü–µ–Ω—Ç—Ä–∞ (15, 15), —Ä–∞–¥–∏—É—Å ~12
                            const centerX = 15;
                            const centerY = 15;
                            const radius = 12;
                            const points = [];
                            for (let i = 0; i < 5; i++) {
                                const angle = (Math.PI * 2 * i) / 5 - Math.PI / 2; // –ù–∞—á–∏–Ω–∞–µ–º —Å–≤–µ—Ä—Ö—É
                                const x = centerX + radius * Math.cos(angle);
                                const y = centerY + radius * Math.sin(angle);
                                points.push(`${x},${y}`);
                            }
                            
                            const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                            polygon.setAttribute('points', points.join(' '));
                            polygon.setAttribute('class', 'heuristic-marker-polygon');
                            svg.appendChild(polygon);
                            marker.appendChild(svg);
                        }
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º tooltip
                        marker.addEventListener('mouseenter', function(e) {
                            const tooltip = document.createElement('div');
                            tooltip.className = 'heuristic-tooltip';
                            tooltip.textContent = `${concern.name} (${concern.value})`;
                            if (isArea) {
                                tooltip.style.left = '50%';
                                tooltip.style.top = '50%';
                                tooltip.style.transform = 'translate(-50%, -50%)';
                            } else if (isDot) {
                                tooltip.style.left = '15px';
                                tooltip.style.top = '15px';
                            } else {
                                tooltip.style.left = '35px';
                                tooltip.style.top = '35px';
                            }
                            marker.appendChild(tooltip);
                        });
                        
                        marker.addEventListener('mouseleave', function() {
                            const tooltip = marker.querySelector('.heuristic-tooltip');
                            if (tooltip) tooltip.remove();
                        });
                        
                        markersContainer.appendChild(marker);
                    });
                };
                
                // –ñ–¥—ë–º –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                if (previewImage.complete) {
                    setTimeout(addMarkers, 100);
                } else {
                    previewImage.onload = addMarkers;
                }
            }
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('DOMContentLoaded', async function() {
            // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥–µ–ª–∏, –ø–æ—Ç–æ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            await loadAvailableModels();
            await loadSettings();
            updateLanguage();
            renderSam3Diseases();
            updateSam3Timeout(sam3Timeout);
            openModeModal();
        });
    </script>
</body>
</html>

